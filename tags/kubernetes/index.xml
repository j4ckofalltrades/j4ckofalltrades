<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>kubernetes on /home/jordan</title><link>https://jduabe.dev/tags/kubernetes/</link><description>Recent content in kubernetes on /home/jordan</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sun, 12 Sep 2021 20:20:20 +0800</lastBuildDate><atom:link href="https://jduabe.dev/tags/kubernetes/index.xml" rel="self" type="application/rss+xml"/><item><title>Writing a custom Powerline plugin</title><link>https://jduabe.dev/posts/2021/powerline-plugin/</link><pubDate>Sun, 12 Sep 2021 20:20:20 +0800</pubDate><guid>https://jduabe.dev/posts/2021/powerline-plugin/</guid><description>&lt;p>&lt;a href="https://github.com/powerline/powerline" class="external-link" target="_blank" rel="noopener">Powerline&lt;/a> is a tool I use as part of
my dev environment setup, and have my config backed up as part of my
&lt;a href="https://github.com/j4ckofalltrades/dotfiles" class="external-link" target="_blank" rel="noopener">dotfiles&lt;/a>.&lt;/p>
&lt;p>It shows helpful information and context for stuff I&amp;rsquo;m working on, as well as
providing some eye-candy for my command line environment.&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/j4ckofalltrades/dotfiles/master/env.png" alt="Env">&lt;/p>
&lt;p>While it comes with a lot of integrations out of the box i.e. &lt;code>bash&lt;/code>, &lt;code>zsh&lt;/code>,
&lt;code>tmux&lt;/code>, &lt;code>vim&lt;/code>, etc, it also provides a way for you to write your own &amp;ldquo;segments&amp;rdquo;.
This should serve as a quick guide for rolling your own custom Powerline
plugin.&lt;/p>
&lt;h2 id="basic-structure-and-configuration">
Basic structure and configuration
&lt;a class="heading-link" href="#basic-structure-and-configuration">
&lt;i class="fa fa-link" aria-hidden="true" title="Link to heading">&lt;/i>
&lt;span class="sr-only">Link to heading&lt;/span>
&lt;/a>
&lt;/h2>
&lt;p>Each powerline segment is a callable object. It is supposed to be either a
Python function or &lt;code>powerline.segments.Segment&lt;/code> class.&lt;/p>
&lt;p>I recently wrote my own custom one that displays the current Kubernetes
context and namespace, which uses a &lt;code>Segment&lt;/code> class. Here is a shortened version
which shows the basic structure.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">class&lt;/span> &lt;span class="nc">KubernetesSegment&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Segment&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Constructs the segment&amp;#39;s sections with the configured colorscheme and
&lt;/span>&lt;span class="s2"> visibility options applied.&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="nd">@staticmethod&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">kube_ctx_info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pl&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Resolves the current active Kubernetes context (and namespace)
&lt;/span>&lt;span class="s2"> from `$KUBECONFIG`.&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">current_context&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list_kube_config_contexts&lt;/span>&lt;span class="p">()[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">current_context&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="s1">&amp;#39;N/A&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> \
&lt;span class="n">current_context&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;context&amp;#39;&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="s1">&amp;#39;namespace&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="s1">&amp;#39;default&amp;#39;&lt;/span>
&lt;span class="k">except&lt;/span> &lt;span class="ne">Exception&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">pl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="fm">__call__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pl&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">pl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">debug&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Running powerline-k8s...&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">sections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;span class="c1"># additional logic to determine segment contents&lt;/span>
&lt;span class="n">sections&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">({&lt;/span>
&lt;span class="s1">&amp;#39;contents&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;u&amp;#39;&lt;/span>\&lt;span class="n">U00002638&lt;/span>&lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;highlight_groups&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;k8s&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s1">&amp;#39;divider_highlight_group&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;k8s:divider&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">sections&lt;/span>
&lt;span class="n">k8s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">with_docstring&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">KubernetesSegment&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Return the current Kubernetes context and namespace.
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2">It will show the current context and namespace from `$KUBECONFIG`.
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2">Divider highlight group used: ``k8s:divider``.
&lt;/span>&lt;span class="s2">
&lt;/span>&lt;span class="s2">Highlight groups used: ``k8s``, ``k8s_context``, ``k8s_namespace``.
&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Custom segment entry point.&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>Make sure to add the &lt;a href="https://pypi.org/project/powerline-status" class="external-link" target="_blank" rel="noopener">powerline-status&lt;/a>
package as a dependency.&lt;/em>&lt;/p>
&lt;p>Basically the class contains a function that returns a &lt;a href="https://powerline.readthedocs.io/en/latest/develop/segments.html#segment-dictionary" class="external-link" target="_blank" rel="noopener">Segment dictionary&lt;/a>
which tells &lt;code>Powerline&lt;/code> what to display. In this particular example, the
following keys were used:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>contents&lt;/code>: Actual segment contents, excluding dividers and before/after.
May be &lt;code>None&lt;/code>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>highlight_groups&lt;/code>, &lt;code>divider_highlight_group&lt;/code>: Used highlight groups.
May be &lt;code>None&lt;/code>.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Highlight groups determine the &amp;lsquo;style&amp;rsquo; that is used for a particular segment
e.g. background and foreground, divider color to clearly distinguish one segment
from another.&lt;/p>
&lt;p>The colors that are available to you will depend on the current colorscheme that
you are using. In general you&amp;rsquo;ll need to add the &amp;ldquo;groups&amp;rdquo; definition to the
colorscheme config file, which in this case was
&lt;code>&amp;lt;powerline_dir&amp;gt;/colorschemes/solarized.json&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;k8s&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;fg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;solarized:blue&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;bg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;solarized:base02&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;attrs&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span> &lt;span class="p">},&lt;/span>
&lt;span class="nt">&amp;#34;k8s:divider&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;fg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;gray4&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;bg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;solarized:base02&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;attrs&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Check out the Powerline docs for a more detailed view into
&lt;a href="https://powerline.readthedocs.io/en/latest/configuration.html" class="external-link" target="_blank" rel="noopener">configuration and customization&lt;/a>.&lt;/p>
&lt;p>The next step is to let Powerline know of the new segment by adding it to the
segment&amp;rsquo;s config file. To add the new segment to the current shell prompt, add
the following entry to the &lt;code>&amp;lt;powerline_dir&amp;gt;/themes/shell/default.json&lt;/code> config
file.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;function&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;k8s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;priority&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">30&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="installation">
Installation
&lt;a class="heading-link" href="#installation">
&lt;i class="fa fa-link" aria-hidden="true" title="Link to heading">&lt;/i>
&lt;span class="sr-only">Link to heading&lt;/span>
&lt;/a>
&lt;/h2>
&lt;p>Once all configuration has been done it&amp;rsquo;s time to &amp;ldquo;install&amp;rdquo; the segment and try
it out, you can do so by executing:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">python3&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">m&lt;/span> &lt;span class="n">pip&lt;/span> &lt;span class="n">install&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">editable&lt;/span> &lt;span class="o">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Installing the package in editable mode saves you from having to &amp;ldquo;re-install&amp;rdquo;
to see the latest changes. If everything went well you should be able to see
your new segment.&lt;/p>
&lt;p>&lt;img src="https://res.cloudinary.com/j4ckofalltrades/image/upload/v1623588713/foss/powerline-k8s_uc0cxj.png" alt="powerline-k8s">&lt;/p>
&lt;h2 id="troubleshooting">
Troubleshooting
&lt;a class="heading-link" href="#troubleshooting">
&lt;i class="fa fa-link" aria-hidden="true" title="Link to heading">&lt;/i>
&lt;span class="sr-only">Link to heading&lt;/span>
&lt;/a>
&lt;/h2>
&lt;p>Having issues with your plugin, try out the following:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Run &lt;code>powerline-lint&lt;/code> to check for errors in the configuration files i.e.
colorscheme and/or segment config.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Restart powerline by running &lt;code>powerline-daemon --replace&lt;/code>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Configure logging with &lt;a href="https://powerline.readthedocs.io/en/master/develop/segments.html#powerlinelogger-class" class="external-link" target="_blank" rel="noopener">PowerlineLogger&lt;/a>
and &lt;a href="https://powerline.readthedocs.io/en/master/configuration/reference.html#config-common-log" class="external-link" target="_blank" rel="noopener">where you want the logs to be written&lt;/a>
for easier debugging.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>It is also worth checking out the &lt;a href="https://powerline.readthedocs.io/en/master/troubleshooting.html" class="external-link" target="_blank" rel="noopener">Powerline docs&lt;/a> for other
common issues that you may encounter.&lt;/p>
&lt;h2 id="misc">
Misc
&lt;a class="heading-link" href="#misc">
&lt;i class="fa fa-link" aria-hidden="true" title="Link to heading">&lt;/i>
&lt;span class="sr-only">Link to heading&lt;/span>
&lt;/a>
&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>Check out the full source on GitHub for the &lt;a href="https://github.com/j4ckofalltrades/powerline-k8s" class="external-link" target="_blank" rel="noopener">powerline-k8s&lt;/a> plugin.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>If you want to share your custom Powerline segment, you might want to check
out this guide about &lt;a href="https://jduabe.dev/posts/pypi-publish/" >publishing packages to PyPI&lt;/a>.&lt;/p>
&lt;/li>
&lt;/ul></description></item></channel></rss>